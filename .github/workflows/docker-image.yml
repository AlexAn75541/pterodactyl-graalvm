name: build aio-jdk

on:
  push:
    branches: [ "dev" ]
  pull_request:
    branches: [ "dev" ]

jobs:
  delete-packages:
    runs-on: ubuntu-latest
    steps:
      - name: Delete untagged Docker images
        uses: Chizkiyahu/delete-untagged-ghcr-action@v6
        with:
          token: ${{ secrets.PAT_TOKEN }}
          repository_owner: ${{ github.repository_owner }}
          repository: ${{ github.repository }}
          untagged_only: true
          owner_type: user

  pterodactyl-aio-jdk:
    name: "pterodactyl-aio-jdk:${{ matrix.tag }}"
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        tag:
         # - 8-EE
         # - 11
         # - 17
         # - 19
         # - 17-JDK
         # - 17-JDK-EEequivalent
         # - 20-JDK
         # - 21-JDK
         # - 21-JDK-EEequivalent
         # - 22-JDK
         # - 11-EE
         # - 17-EE
         # - 23
         # - 23-JDK-EEequivalent
          - experimental-21
          - aio-8
          - aio-11
          - aio-17
          - aio-21
          - aio-25
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Free disk space
        run: |
          echo "=== Disk space BEFORE cleanup ==="
          df -h /
          # Remove pre-installed tools we don't need
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache
          sudo rm -rf /usr/local/share/boost
          sudo rm -rf /usr/share/swift
          sudo rm -rf /usr/local/graalvm
          sudo rm -rf /usr/local/.ghcup
          sudo rm -rf "$AGENT_TOOLSDIRECTORY"
          # Clean apt cache
          sudo apt-get clean
          # Clean docker images that are pre-cached
          docker image prune -af
          echo "=== Disk space AFTER cleanup ==="
          df -h /

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v2
        
      - name: Set up Docker Buildx
        id: buildx
        uses: docker/setup-buildx-action@v2

      - name: Login to GHCR
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v3.1.0
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Docker meta
        id: meta_graalvm
        uses: docker/metadata-action@v4
        with:
          # list of Docker images to use as base name for tags
          images: |
            ghcr.io/alexan75541/pterodactyl-aio-jdk
          # generate Docker tags based on the following events/attributes
          tags: |
            type=raw,${{ matrix.tag }}
            
      - name: Build and push
        uses: docker/build-push-action@v3
        with:
          context: .
          file: ./${{ matrix.tag }}/Dockerfile
          platforms: linux/amd64,linux/arm64
          push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ steps.meta_graalvm.outputs.tags }}
          labels: ${{ steps.meta_graalvm.outputs.labels }}
